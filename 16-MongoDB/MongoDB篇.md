

## 什么是MongoDB

官方文档：https://www.mongodb.com/docs/v5.0/

-   MongoDB是一个**开源、高性能、无模式**的**文档型数据库**，当初的设计就是用于简化开发和方便扩展，是NoSQL数据库产品中的一种。
    -   MongoDB是一个基于分布式文件存储的数据库。由C++编写，皆在为WEB应用提供可扩展的高性能数据存储解决方案。
    -   是最像关系型数据库（MySQL）的非关系型数据库。是**介于关系型数据库与非关系型数据库**之间的。
-   它支持的**数据结构非常松散**，是一种类似于 JSON 的 格式叫 **BSON**，所以它既可以存储比较复杂的数据类型，又相当的灵活。 
    -   数据类型例如：{“key”:"value", "like":["",""]}
    -   MongoDB最大的特点就是它支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以**实现类似于关系型数据库单表查询的绝大部分功能，而且它还支持对数据建立索引。**
        -   扩展：HBase的皮肤Phoenix也支持关系型数据库单表查询的绝大部分功能
-   MongoDB中的记录是一个文档，它是一个由字段和值对（field:value）组成的数据结构。**MongoDB文档类似于JSON对象**，即**一个文档认为就是一个对象**。
    -   字段的数据类型是字符型，它的值除了使用基本的一些类型外，还可以包括其他文档、普通数组和文档数组。

## MongoDB历史

-   2009年2月，MongoDB数据库首次在数据库领域亮相，打破了关系型数据库一统天下的局面；
-   2010年8月，MongoDB1.6发布。这个版本最大的一个功能就是Sharding，自动分片；
-   2014年12月，MongoDB3.0发布。由于收购了WiredTiger 存储引擎，**大幅提升了MongoDB的写入性能**；
-   2015年12月，3.2版本发布，开始支持了关系型数据库的核心功能：**关联**。你可以一次同时查询多个MongoDB的集合。
-   2016年，MongoDB推出Atlas，在AWS、Azure 和GCP上的MongoDB托管服务；
-   2017年10月，MongoDB成功在纳斯达克敲钟，成为26年来第一家以数据库产品为主要业务的上市公司
-   2018年6月，MongoDB4.0发布推出**ACID事**务支持，成为第一个支持强事务的NoSQL数据库；
-   2018年-至今，MongoDB已经从一个在数据库领域籍籍无名的“小透明”，变成了话题度和热度都很高的“流量”数据库。



## MongoDB特点及应用

传统的关系型数据库（如MySQL），在数据操作的“三高”需求以及应对Web2.0的网站需求面前，显得力不从心。 

解释：“三高”需求： 

-   High performance - 对数据库**高并发读写**的需求。 
-   Huge Storage - 对海量数据的**高效率存储和访问**的需求。 
-   High Scalability && High Availability- 对数据库的**高可扩展性和高可用性**的需求。 

而MongoDB可应对“三高”需求

### MongoDB的特点

MongoDB主要有如下特点： 

（1）**高性能**： 

MongoDB提供高性能的数据持久性。特别是, 对嵌入式数据模型的支持减少了数据库系统上的I/O活动。 

**索引**支持更快的查询，并且可以包含来自嵌入式文档和数组的键。（文本索引解决搜索的需求、TTL索引解决历史数据自动过期的需求、地理位置索引可用于构建各种 O2O 应用） 

mmapv1、wiredtiger、mongorocks（rocksdb）、in-memory 等多引擎支持满足各种场景需求。 

Gridfs解决文件存储的需求。 

（2）**高可用性：** 

MongoDB的复制工具称为副本集（replica set），它可提供自动故障转移和数据冗余。 

（3）**高扩展性：** 

MongoDB提供了水平可扩展性作为其核心功能的一部分。 

分片将数据分布在一组集群的机器上。（海量数据存储，服务能力水平扩展） 

从3.4开始，MongoDB支持基于片键创建数据区域。在一个平衡的集群中，MongoDB将一个区域所覆盖的读写只定向到该区域内的那些片。 

（4）**丰富的查询支持：** 

MongoDB支持丰富的查询语言，支持读和写操作(CRUD)，比如数据聚合、文本搜索和地理空间查询等。 

（5）其他特点：如无模式（动态模式）、灵活的文档模型、 

**小结MongoDB特点**

-   面向集合存储，易存储对象类型的数据
-   支持查询，以及动态查询
-   支持RUBY，PYTHON，JAVA, C++。PHP，C#等多种语言
-   文件存储格式为BSON（一种JSON的扩展）
-   支持复制和故障恢复和分片
-   支持事务（在5.x版本目前只支持单条事务，不支持集合式事务）
-   支持索引、聚合、关联

### 具体的应用场景

1）社交场景，使用 MongoDB 存储存储用户信息，以及用户发表的朋友圈信息，通过地理位置索引实现附近的人、地点等功能。 

2）游戏场景，使用 MongoDB 存储游戏用户信息，用户的装备、积分等直接以内嵌文档的形式存储，方便查询、高效率存储和访问。 

3）物流场景，使用 MongoDB 存储订单信息，订单状态在运送过程中会不断更新，以 MongoDB 内嵌数组的形式来存储，一次查询就能将订单所有的变更读取出来。 

4）物联网场景，使用 MongoDB 存储所有接入的智能设备信息，以及设备汇报的日志信息，并对这些信息进行多维度的分析。 

5）视频直播，使用 MongoDB 存储用户信息、点赞互动信息等。 

这些应用场景中，数据操作方面的共同特点是： 

（1）数据量大 

（2）写入操作频繁（读写都很频繁） 

（3）价值较低的数据，对事务性要求不高 

对于这样的数据，我们更适合使用MongoDB来实现数据的存储。 

**什么时候选择MongoDB** 

在架构选型上，除了上述的三个特点外，如果你还犹豫是否要选择它？可以考虑以下的一些问题： 

​	应用不需要事务及复杂 join 支持 

​	新应用，需求会变，数据模型无法确定，想快速迭代开发 

​	应用需要2000-3000以上的读写QPS（更高也可以） 

​	应用需要TB甚至 PB 级别数据存储 

​	应用发展迅速，需要能快速水平扩展 

​	应用要求存储的数据不丢失 

​	应用需要99.999%高可用 

​	应用需要大量的地理位置查询、文本查询 

如果上述有1个符合，可以考虑 MongoDB，2个及以上的符合，选择 MongoDB 绝不会后悔



## MongoDB体系结构/核心概念

**DataBase**

**mongodb中的库就类似于传统关系型数据库中库的概念，用来通过不同库隔离不同应用数据。**

mongodb中可以建立多个数据库。每一个库都有自己的集合和权限，不同的数据库也放置在不同的文件中。默认的数据库为"test”，数据库存储在启动时指定的data目录中

**Collection**

集合就是 MongoDB 文档组，类似于 RDBMS**（关系数据库管理系统：RelationalDatabase Management System）**中的表的概念。

集合存在于数据库中，一个库中可以创建多个集合。每个集合没有固定的结构，这意味着你在对集合可以插入不同格式和类型的数据，但通常情况下我们插入集合的数据都会有一定的关联性。

**Document**

文档集合中一条条记录，是一组键值（key-value）对（即 BSON）。MongoDB 的文档不需要设置相同的字段，并且相同的字段不需要相同的数据类型，这与关系型数据库有很大的区别，也是 MongoDB非常突出的特点。
一个简单的文档例子如下：

```json
{"site":"www.clear.com","name":"nhk"}
```



## RDBMS与 MongoDB对比

| SQL术语/概念 | MongoDB术语/概念 | 解释/说明                               |
| ------------ | ---------------- | --------------------------------------- |
| database     | database         | 数据库                                  |
| table        | collection       | 数据库表/集合                           |
| row          | document         | 数据记录行/文档                         |
| column       | field            | 数据字段/域                             |
| index        | index            | 索引                                    |
| table joins  |                  | 表连接,MongoDB不支持                    |
|              | 嵌入文档         | MongoDB**通过嵌入式文档来替代多表连接** |
| primary key  | primary key      | 主键,**MongoDB自动将_id字段设置为主键** |



## MongoDB数据模型 

-   **MongoDB的最小存储单位就是文档(document)对象**。文档(document)对象对应于关系型数据库的行。数据在MongoDB中以BSON（Binary-JSON）文档的格式存储在磁盘上。 
-   BSON（Binary Serialized Document Format）是一种类json的一种二进制形式的存储格式，简称Binary JSON。BSON和JSON一样，支持内嵌的文档对象和数组对象，但是BSON有JSON没有的一些数据类型，如Date和BinData类型。 
-   BSON采用了类似于 C 语言结构体的名称、对表示方法，支持内嵌的文档对象和数组对象，具有轻量性、可遍历性、高效性的三个特点，可以有效描述非结构化数据和结构化数据。这种格式的优点是灵活性高，但它的缺点是空间利用率不是很理想。 
-   Bson中，除了基本的JSON类型：string,integer,boolean,double,null,array和object，mongo还使用了特殊的数据类型。这些类型包括 date,object id,binary data,regular expression 和code。每一个驱动都以特定语言的方式实现了这些类型，查看你的驱动的文档来获取详细信息。 

BSON数据类型参考列表：

| 数据类型      | 描述                                                         | 举例                                                 |
| ------------- | ------------------------------------------------------------ | ---------------------------------------------------- |
| 字符串        | UTF-8字符串都可表示为字符串类型的数据                        | {"x" : "foobar"}                                     |
| 对象id        | 对象id是文档的12字节的唯一 ID                                | {"X" :ObjectId() }                                   |
| 布尔值        | 真或者假：true或者false                                      | {"x":true}                                           |
| 数组          | 值的集合或者列表可以表示成数组                               | {"x" ： ["a", "b", "c"]}                             |
| 32位整数      | 类型**不可用**。JavaScript仅支持64位浮点数，所以32位整数会被自动转换。 | shell是不支持该类型的，shell中默认会转换成64位浮点数 |
| 64位整数      | **不支持**这个类型。shell会使用一个特殊的内嵌文档来显示64位整数 | shell是不支持该类型的，shell中默认会转换成64位浮点数 |
| 64位浮点数    | shell中的数字就是这一种类型                                  | {"x"：3.14159，"y"：3}                               |
| null          | 表示空值或者未定义的对象                                     | {"x":null}                                           |
| undefined     | 文档中也可以使用未定义类型                                   | {"x":undefined}                                      |
| 符号          | shell**不支持**，shell会将数据库中的符号类型的数据自动转换成字符串 |                                                      |
| 正则表达式    | 文档中可以包含正则表达式，采用JavaScript的正则表达式语法     | {"x" ： /foobar/i}                                   |
| 代码          | 文档中还可以包含JavaScript代码                               | {"x" ： function() { /* …… */ }}                     |
| 二进制数据    | 二进制数据可以由任意字节的串组成，不过shell中无法使用        |                                                      |
| 最大值/最小值 | BSON包括一个特殊类型，表示可能的最大值。shell中没有这个类型。 |                                                      |

提示： 

​	shell默认使用64位浮点型数值。{“x”：3.14}或{“x”：3}。对于整型值，可以使用NumberInt（4字节符号整数）或NumberLong（8字节符号整数），{“x”:NumberInt(“3”)}{“x”:NumberLong(“3”)} 

例如：

在关系型数据库中

| id   | user_name  | email        | age  | city        |
| ---- | ---------- | ------------ | ---- | ----------- |
| 1    | Mark Hanks | mark@abc.com | 25   | Los Angeles |

BSON

```json
{
	"_id": ObjectId("5146bb52d8524270060001f3"),
    "age": 25,
    "city": "Los Angeles",
    "email": "mark@abc.com",
    "user_name": "Mark Hanks"
}
```



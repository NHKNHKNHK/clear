# Redis的持久化机制？| Redis有哪些持久化方式？

## **口语化**

redis主要提供了两种持久化方式，rdb 和 aof，它们也可以混合使用。**rdb** 主要是在**指定的时间间隔**内生成数据集的**快照**，并将其保存到磁盘上，生成一个 rdb 格式的二进制文件，容易备份，恢复速度快，适合用于灾难恢复。aof持久化方式是记录每一个写操作到日志文件中，Redis会将这些写操作以追加的方式写入到aof文件中。每次恢复的时候，进行重放。aof 相比 rdb 就是文件会大一些，恢复速度慢一些，但是数据丢失风险小。在实际中，一般可以选择混合互补的方式使用。

>   rdb，aof，混合持久化



Redis 提供了 2 个不同形式的持久化方式：

-   RDB（Redis DataBase）
-   AOF（Append Only File）

>   Redis 4.0引入了**混合持久化模式**

## **RDB（Redis DataBase）**

在指定的**时间间隔**内将内存中的数据集**快照**写入磁盘（ 也就是行话讲的 snapshot 快照），默认是生成一个名为`dump.rdb`的文件，它恢复时是将快照文件直接读到内存里。

RDB的配置可以在redis.conf文件中进行。例如：

```shell
save 900 1      # 如果900秒（15分钟）内至少有1个键发生变化，就触发一次RDB快照
save 300 10     # 如果300秒（5分钟）内至少有10个键发生变化，就触发一次RDB快照
save 60 10000   # 如果60秒（1分钟）内至少有10000个键发生变化，就触发一次RDB快照
```

### **优点**

1、RDB文件是一个紧凑的二进制文件，可以很容易地进行备份。

2、 恢复速度快，适合用于灾难恢复。

3、 对Redis性能影响较小，因为生成RDB文件的工作是在子进程中进行的。

### **缺点**

1、 数据持久化的频率较低，可能会丢失最近一次快照之后的数据。

2、 生成RDB快照时，可能会消耗较多的CPU和内存资源。因为Fork 的时候，内存中的数据被克隆了一份，大致 2 倍的膨胀性需要考虑



## **AOF（Append Only File）**

**以日志的形式来记录每个写操作（增量保存）**，将 Redis 执行过的所有写指令记录下来 (读操作不记录)， **只许追加文件但不可以改写文件**，redis 启动之初会读取该文件重新构建数据。

日志文件默认名为`appendonly.aof`

换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。

AOF的配置可以在redis.conf文件中进行。例如：

```shell
appendonly yes         # 启用AOF持久化
appendfilename "appendonly.aof"
appendfsync everysec   # 每秒钟同步一次AOF文件
# 其他选项：
# appendfsync always  # 每个写操作都同步到AOF文件，性能较差但数据最安全
# appendfsync no      # 由操作系统决定何时同步，性能最好但数据安全性较差
```

### **AOF同步频率**

-   appendfsync always：**始终同步，每次 Redis 的写入都会立刻记入日志**；性能较差但数据完整性比较好。
-   appendfsync everysec：**每秒同步，每秒记入日志一次，如果宕机，本秒的数据可能丢失**。
-   appendfsync no：redis 不主动进行同步，**把同步时机交给操作系统**。性能最好，可靠性较差，可能会丢失大量数据。

### **优点**

1、数据恢复更可靠，AOF可以记录每一个写操作，数据丢失风险较小。

2、AOF文件是可读的文本文件，方便分析和调试。

### **缺点**

1、 AOF文件比RDB文件大，占用更多的磁盘空间，恢复速度较慢。

2、 持久化频率高时，可能会影响Redis性能。

3、 需要定期进行AOF重写（rewrite），以避免文件过大。



## **混合持久化（Hybrid Persistence）**

混合持久化模式结合了RDB和AOF的优点。在Redis 4.0及以上版本中，混合持久化模式在生成新的AOF文件时，会首先创建一个RDB快照，然后在快照之后追加AOF日志。

这种方式可以在保证数据恢复速度的同时，减少数据丢失的风险。

混合持久化的配置可以在redis.conf文件中进行

```shell
aof-use-rdb-preamble yes  # 启用混合持久化模式
```

### **优点**：

1、 结合了RDB和AOF的优点，既能快速恢复数据，又能减少数据丢失的风险。



官方推荐两个都启用：

-   如果对数据不敏感，可以选单独用 RDB。
-   不建议单独用 AOF，因为可能会出现 Bug。
-   如果只是做纯内存缓存，可以都不用

## **官网建议**

-   RDB 持久化方式能够在指定的时间间隔能对你的数据进行快照存储。
-   AOF 持久化方式记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据，AOF 命令以 redis 协议追加保存每次写的操作到文件末尾。Redis 还能对 AOF 文件进行后台重写，使得 AOF 文件的体积不至于过大。
-   只做缓存：如果你只希望你的数据在服务器运行的时候存在，你也可以不使用任何持久化方式。
-   同时开启两种持久化方式：
    -   在这种情况下，当 redis 重启的时候会优先载入 AOF 文件来恢复原始的数据，因为在通常情况下 AOF 文件保存的数据集要比 RDB 文件保存的数据集要完整。
    -   RDB 的数据不实时，同时使用两者时服务器重启也只会找 AOF 文件。那要不要只使用 AOF 呢？建议不要，因为 RDB 更适合用于备份数据库 (AOF 在不断变化不好备份)，快速重启，而且不会有 AOF 可能潜在的 bug，留着作为一个万一的手段。
-   性能建议：
    -   因为 RDB 文件只用作后备用途，建议只在 Slave 上持久化 RDB 文件，而且只要 15 分钟备份一次就够了，只保留 save 900 1 这条规则。
    -   如果使用 AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单，只 load 自己的 AOF 文件就可以了。
    -   aof 代价：一是带来了持续的 IO，二是 AOF rewrite 的最后，将 rewrite 过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。
    -   只要硬盘许可，应该尽量减少 AOF rewrite 的频率，AOF 重写的基础大小默认值 64M 太小了，可以设到 5G 以上。默认超过原大小 100% 大小时重写可以改到适当的数值。 



# MySQL聚簇索引与非聚簇索引（InnoDB中）

索引按照物理实现方式，索引可以分为 2 种：聚簇（聚集）和非聚簇（非聚集）索引。

非聚集索引又称为二级索引或者辅助索引

## 口语化

**聚簇索引**，“聚簇聚簇”顾名思义就是将数据与索引放到了一起，找到索引也就找到了数据。也就是说，对于聚簇索引来说，他的非叶子节点上存储的是索引字段的值，而他的叶子节点上存储的是这条记录的整行数据。

**在InnoDB中，聚簇索引（Clustered Index）指的是按照每张表的主键构建的一种索引方式**，它是将表数据按照主键的顺序存储在磁盘上的一种方式。这种索引方式保证了行的物理存储顺序与主键的逻辑顺序相同，因此查找聚簇索引的速度非常快。

**非聚簇索引**，就是将数据与索引分开存储，叶子节点包含索引字段值及指向数据页数据行的逻辑指针。

**在Innodb中，非聚簇索引（Non-clustered Index）是指根据非主键字段创建的索引**，也就是通常所说的二级索引。它不影响表中数据的物理存储顺序，而是单独创建一张索引表，用于存储索引列和对应行的指针。


在InnoDB中，主键索引就是聚簇索引，而非主键索引，就是非聚簇索引，所以在InnoDB中：

- **对于聚簇索引来说，他的非叶子节点上存储的是索引值，而它的叶子节点上存储的是`整行记录`**
- **对于非聚簇索引来说，他的非叶子节点上存储的都是索引值，而它的叶子节点上存储的是`主键的值+索引值`**

**所以，通过非聚簇索引的查询，需要进行一次回表，就是先查到主键ID，在通过ID查询所需字段。**

> 什么是

## 聚簇索引（Clustered Index）

聚簇索引并不是一种单独的索引类型，而是**一种数据存储方式**（所有的用户记录都存储在了叶子节点），也就是所谓的`索引即数据，数据即索引`

:::tip 术语
“聚簇”表示数据行和相连的键值聚簇的存储在一起
:::

### 特点

- 1、使用记录主键值的大小进行记录和页的排序，这包括三个方面的含义：
  - `页内` 的记录是按照主键的大小顺序排成一个 `单向链表` 。
  - 各个存放 `用户记录的页` 也是根据页中用户记录的主键大小顺序排成一个 `双向链表` 。
  - 存放 `目录项记录的页` 分为不同的层次，在同一层次中的页也是根据页中目录项记录的主键大小顺序排成一个 `双向链表` 。
- 2、B+树的 `叶子节点` 存储的是完整的用户记录。

所谓完整的用户记录，就是指这个记录中存储了所有列的值（包括隐藏列）。

我们把具有这两种特征的B+数称为`聚簇索引`。所有完整的用户记录都会被存放在这个`聚簇索引`的叶子节点中。

:::warning 注意
聚簇索引并不需要我们在MySQL语句中显式的使用`INDEX`语句创建，`InnoDB`存储引擎会`自动`为我们创建聚簇索引。
:::

### 优点

- `数据访问更快`，因为聚簇索引将索引和数据保存在同一个B+树中，因此从聚簇索引中获取数据比非聚簇索引更快（不需要回表）
- 聚簇索引对于主键的 `排序查找` 和 `范围查找` 速度非常快
- 按照聚簇索引排列顺序，查询显示一定范围数据的时候，由于数据都是紧密相连，数据库不用从多个数据块中提取数据，所以 `节省了大量的IO操作` 。

### 缺点

- `插入速度严重依赖于插入顺序`，按照主键的顺序插入是最快的方式，否则将会出现**页分裂**，严重影响性能。因此，对于InnoDB表，我们一般都会定义一个**自增的ID列为主键**
- `更新主键的代价很高`，因为将会导致被更新的行移动。因此，对于InnoDB表，我们一般定义**主键为不可更新**
- `二级索引访问需要两次索引查找`，第一次找到主键值，第二次根据主键值找到行数据（也就是回表）

:::tip
在 InnoDB 存储引擎中，页分裂（Page Split） 是指当数据页（默认大小为 16KB）因插入或更新操作导致空间不足时，将原页的部分数据迁移到新分配的页中，从而维持 B+ 树索引结构平衡和有序性的过程。

具体来说，当一个数据页（无论是叶子节点还是非叶子节点）已满且无法容纳新数据时，InnoDB 会创建一个新页，将原页中约 50% 的数据移动到新页，并更新父节点和双向链表的指针，以保证索引树的平衡性和数据的有序存储。这一机制是 InnoDB 维护 B+ 树高效查询能力的核心手段，但频繁的页分裂会带来 I/O 开销和索引碎片等性能问题。

详细查看：[什么是InnoDB的页分裂和页合并](./什么是InnoDB的页分裂和页合并.md)
:::

### 限制

- 对于MySQL，目前只有InnoDB存储引擎支持聚簇索引，而MyISAM并不支持聚簇索引。
- 由于数据存储存储排序方式只有一种，所以每个MySQL的`表只能有一个聚簇索引`。一般情况下就是该表的主键。
- 如果没有定义主键，InnoDB会选择一个`非空唯一索引`代替。如果没有适合的非空唯一索引，InnoDB会隐式定义一个主键作为聚簇索引。
- 为了充分利用聚簇索引的聚簇特性，所以InnoDB表的主键列尽量设置为`选用有序的顺序id`。而不建议用无序id，如UUID、MD5、HASH、字符串等作为主键，因为无法保证数据的顺序增长。

## 非聚簇索引（Non-clustered Index）|二级索引|辅助索引

当我们想以别的列（非主键）来作为查询条件来查询数据，我们看到不能从头到尾沿着链表依次遍历。

此时我们就需要使用非聚簇索引。

非聚簇索引也叫辅助索引，也叫二级索引。他也是B+树，但是它的叶子节点存储的不是完整的用户记录，而是主键值。

一张表中可以创建多个非聚簇索引，但是表只能有一个聚簇索引（通常是主键）

## 结论

- 聚簇索引的`叶子节点`存储的就是完整的用户记录，而非聚簇索引的叶子节点存储的是`数据位置（一般为主键值）`。非聚簇索引不会影响数据表的物理存储顺序。
- 一个表中只能有一个聚簇索引，因为只能有一种排序存储的方式；但是可以有多个非聚簇索引，也就是多个索引目录以供数据检索
- 使用聚簇索引的数据，数据的`查询效率高`，但如果对数据进行插入、删除和更新操作，其性能会比非聚簇索引低一些。这是因为每次数据变动都会引起内部存储结构的调整

## 联合索引

:::warning 注意
联合索引，严格意义来说，就是二级索引（非聚簇索引）。所以联合索引的B+树结构也是与非聚簇索引一样。
:::

[什么是联合索引（复合索引）？](./什么是联合索引（复合索引）？)

## 扩展

### 没有创建主键怎么办？

我们知道，Innodb中的聚簇索引是按照每张表的主键构造一个B+树，那么如果我们在表结构中没有定义主键，那怎么办呢？


如果没有定义主键，InnoDB会选择一个`非空唯一索引`代替。

如果没有适合的非空唯一索引，InnoDB则会隐式定义一个主键（row_id）作为聚簇索引。

这个隐式的主键包含一个自增列和一个6字节的定长记录指针，对用户透明，即用户无法看到或修改这个列，但可以通过使用该列来进行排序或连接操作。

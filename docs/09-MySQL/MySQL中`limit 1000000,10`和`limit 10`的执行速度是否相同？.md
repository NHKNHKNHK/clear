# MySQL中`limit 1000000,10`和`limit 10`的执行速度是否相同？ MySQL深分页

>  本题考察面试者对数据库查询语句的优化、性能调优的了解
> 
>  主要考察的是 limit的实现机制、如何优化深分页

## 口语化

`limit 1000000,10`和`limit 10`的执行速度差异主要却决于两个关键因素

1、数据量

如果数据库中的数据量很小，那么两个查询的速度相差可能不是很大

但是如果数据库中的数据量很大，那么 limit 1000000,10 会跳过大量的数据行才能返回结果；而limit 10则不需要跳过

:::warning
limit 1000000,10会从存储引擎中获取1000000条数据，并全部丢弃，直到从1000000条数据时才开始拿到10条数据交给客户端

这里是数据库读取了1000000条数据，不要误解为是跳过1000000条数据，这样子磁盘、内存、CPU等全部浪费了（这就是所谓的深度分页问题）
:::

2、索引

如果表中有合适的索引，那么使用 limit 1000000,10 的时候数据库可以通过索引直接定位到指定的行号返回结果，而对于limit 10数据库只需要返回前10行数据即可。



但是不管什么因素，limit 1000000,10的查询速度肯定是要慢于limit 10，而随着数据量的增加前者的查询速度会更慢。

因此我认为可以从两个方面来优化：

1、SQL语句层面优化

假设存在主键id，可以使用子查询语句的查询结果作为过滤条件，从第999999行的主键值开始获取10行数据，这样可以跳过大量的数据行，提高查询效率

```sql
select * from where id (select id from order by id limit 1 offset 999999)
    order by id
    limit 10;
```

2、从业务层面优化

正常情况下，很少会出现翻100w页查询一个数据的情况，这种设计本身就会存在问题。

如果涉及到大量数据翻页的查询，可以尝试做冷热数据的分离，减少热数据的查询量。

或者针对运营用到的数据做分析，形成固化表以后展示出来。



 **执行速度差异的原因**

(1) **偏移量的影响**

-   `LIMIT 1000000, 10` 的偏移量为 1000000，这意味着 MySQL 必须先扫描或跳过前 1000000 条记录，才能定位到目标记录。
-   如果数据量较大且没有合适的索引支持，这种操作可能会非常耗时。

(2) **索引的作用**

-   如果查询条件中使用了索引（例如通过 `WHERE` 子句过滤数据），MySQL 可以利用索引快速定位到目标记录，从而减少扫描的开销。
-   然而，即使有索引，`LIMIT 1000000, 10` 仍然需要遍历索引树中的前 1000000 条记录，这仍然是一个较大的开销。

(3) **内存和磁盘 I/O**

-   对于较大的偏移量（如 1000000），MySQL 可能需要从磁盘加载更多的数据块到内存中，进一步增加查询的延迟。


## 总结

`limit 1000000,10`本质上就是深度分页问题

深度分页问题的本质就是因为offset很大，数据库需要跳过大量的数据，成本比较大




## 扩展 如何优化深度分页

### 记录上一次id

方案一：记录当前页最后一条数据的id，下次请求时携带上。

优点：轻、快、不需要跳页

使用场景：下拉加载、连续滚动翻页

缺点：不能跳页

> 本质上就是游标式分页，通过上次最后一条数据id作为锚点，继续往后

### 子查询优化

方案二：子查询优化

例如，如下sql
```sql
select * from user
where name = 'clear'
order by id
limit 1000000, 10;
```

只要在name字段上建议索引，sql就可以优化为如下：

```sql
select * from user
where name = 'clear'
and id >= (
    selecr id from user
    where name = 'clear'
    order by id
    limit 1000000, 1
)
order by id
limit 10;
```
因为二级索引的数据量少，就索引列和主键，所以子查询中能直接得到id，不需要进行回表。

然后将子查询得到的id再去进行主键索引，这样子速度快，数据量也少。

:::tip
这个优化的sql也可以写成join的方式，不再赘述
:::

### ElasticSearch

注意：ElasticSearch也存在深度分页问题，如果不熟悉，就不要说
# 数据库日志

为什么需要数据库日志？

对于一个线上数据库应用系统来说，突然遭遇数据库宕机怎么办？

在这种情况下，定位宕机的原因就非常关键。我们可以查看数据库的`错误日志（error log）`。因为日志中记录了数据库运行中的诊断信息，包括了错误、警告和注释等信息。

比如：从日志中发现某个连接中的 SQL 操作发生了死循环，导致内存不足，被系统强行终止了。明确了原因，处理起来也就轻松了，系统很快就恢复了运行。

除了发现错误，日志在数据复制、数据恢复、操作审计，以及确保数据的永久性和一致性等方面，都有着不可替代的作用。

:::tip

千万不要小看日志。很多看似奇怪的问题，答案往往就藏在日志里。很多情况下，只有通过查看日志才能发现问题的原因，真正解决问题。

所以，一定要学会查看日志，养成检查日志的习惯，对提升你的数据库应用开发能力至关重要。

:::

> MySQL8.0 官网日志地址：https://dev.mysql.com/doc/refman/8.0/en/server-logs.html

## MySQL支持的日志

### 日志类型

MySQL有不同类型的日志文件，用来存储不同类型的日志，分为`二进制日志`、`错误日志`、`通用查询日志`和`慢查询日志`，这也是常用的4种。

MySQL 8又新增两种支持的日志：`中继日志`和`数据定义语句日志`。

使用这些日志文件，可以查看MySQL内部发生的事情。

- **慢查询日志**：记录所有执行时间超过`long_query_time`的所有查询，方便我们对查询进行优化。

- **通用查询日志**：记录所有连接的起始时间和终止时间，以及连接发送给数据库服务器的所有指令，对我们复原操作的实际场景、发现问题，甚至是对数据库操作的审计都有很大的帮助。

- **错误日志**：记录MySQL服务的启动、运行或停止MySQL服务时出现的问题，方便我们了解服务器的状态，从而对服务器进行维护。

- **二进制日志**：记录所有更改数据的语句，可以用于主从服务器之间的数据同步，以及服务器遇到故障时数据的无损失恢复。

- **中继日志**：用于主从服务器架构中，从服务器用来存放主服务器二进制日志内容的一个中间文件。从服务器通过读取中继日志的内容，来同步主服务器上的操作。

- **数据定义语句日志**：记录数据定义语句执行的元数据操作。

:::warning 注意

除二进制日志外，其他日志都是`文本文件`。默认情况下，所有日志文件都位于`MySQL数据目录`中。

:::

### 日志的弊端

- 日志功能会`降低MySQL数据库的性能`。例如，在查询非常频繁的 MySQL 数据库系统中，如果开启了通用查询日志和慢查询日志，MySQL 数据库会花费很多时间记录日志。

- 日志会`占用大量的磁盘空间`。对于用户量非常大、操作非常频繁的数据库，日志文件需要的存储空间设置比数据库文件需要的存储空间还要大。

## 慢查询日志（slow query log）

> [慢查询日志（slow query log）：定位执行慢的SQL](./性能分析工具的使用.md#slow-query-log)

## 通用查询日志（general query log）

通用查询日志用来`记录用户的所有操作`，包括启动和关闭MySQL服务、所有用户的连接开始时间和截止时间、发给 MySQL 数据库服务器的所有 SQL 指令等。当我们的数据发生异常时，**查看通用查询日志，还原操作时的具体场景**，可以帮助我们准确定位问题。

### 问题描述——引入为什么需要通用查询日志

在电商系统中，购买商品并且使用微信支付完成以后，却发现支付中心的记录并没有新增，此时用户再次使用支付宝支付，就会出现`重复支付`的问题。但是当去数据库中查询数据的时候，会发现只有一条记录存在。那么此时给到的现象就是只有一条支付记录，但是用户却支付了两次。

我们对系统进行了仔细检查，没有发现数据问题，因为用户编号和订单编号以及第三方流水号都是对的。可是用户确实支付了两次，这个时候，我们想到了检查通用查询日志，看看当天到底发生了什么。

查看之后，发现：1 月 1 日下午 2 点，用户使用微信支付完以后，但是由于网络故障，支付中心没有及时收到微信支付的回调通知，导致当时没有写入数据。1 月 1 日下午 2 点 30，用户又使用支付宝支付，此时记录更新到支付中心。1 月 1 日晚上 9 点，微信的回调通知过来了，但是支付中心已经存在了支付宝的记录，所以只能覆盖记录了。

由于网络的原因导致了重复支付。至于解决问题的方案就很多了，这里省略。

可以看到通用查询日志可以帮助我们了解操作发生的具体时间和操作的细节，对找出异常发生的原因极其关键。

:::warning 扩展

重复支付

:::

### 查看当前状态

```sql
mysql> SHOW VARIABLES LIKE '%general%';
+------------------+-------------------------+
| Variable_name    | Value                   |
+------------------+-------------------------+
| general_log      | OFF                     | #通用查询日志处于关闭状态
| general_log_file | /var/lib/mysql/test.log | #通用查询日志文件的名称是test.log
+------------------+-------------------------+
2 rows in set (0.03 sec)
```

说明：

- 系统变量 `general_log` 的值是 `OFF`，即通用查询日志处于关闭状态。在 MySQL 中，这一参数`默认是关闭的`。因为一旦开启记录通用查询日志，MySQL 会记录所有的连接起止和相关的 SQL 操作，这样会消耗系统资源并且占用磁盘空间。我们可以通过手动修改变量的值，在`需要的时候开启日志`。

- 通用查询日志文件的名称是 `test.log`。存储路径是 `/var/lib/mysql/`，默认也是数据路径。这样我们就知道在哪里可以查看通用查询日志的内容了。

### 启动日志

**方式 1：永久性方式**

修改 `my.cnf` 或者 `my.ini` 配置文件来设置。在 `[mysqld]` 组下加入 `log` 选项，并重启 MySQL 服务。格式如下：

```ini
[mysqld]
general_log=ON
general_log_file=[path[filename]]  #日志文件所在目录路径，filename为日志文件名
```

如果不指定目录和文件名，通用查询日志将默认存储在 MySQL 数据目录中的 `hostname.log` 文件中，`hostname` 表示主机名。

**方式 2：临时性方式**

```sql
SET GLOBAL general_log=on; # 开启通用查询日志

SET GLOBAL general_log_file=’path/filename’; # 设置日志文件保存位置

SET GLOBAL general_log=off; # 关闭通用查询日志

SHOW VARIABLES LIKE 'general_log%'; # 查看设置后情况
```

### 查看日志

通用查询日志以`文本文件`形式存储，可通过文本编辑器直接打开，且每台 MySQL 服务器的通用查询日志内容不同。

查看方式：

- Windows 系统：使用文本文件查看器；
- Linux 系统：使用 vi 工具或 gedit 工具；
- Mac OSX 系统：使用文本文件查看器或 vi 等工具。

可通过执行`SHOW VARIABLES LIKE 'general_log%';`查看通用查询日志的位置。

通过通用查询日志，我们可以了解用户对 MySQL 的操作，比如 MySQL启动信息、用户root连接服务器及执行查询表的记录等。

如下是一个通用查询日志的例子：

```shell
/usr/sbin/mysqld, Version: 8.0.26 (MySQL Community Server - GPL). started with:
Tcp port: 3306 Unix socket: /var/lib/mysql/mysql.sock
Time      Id  Command Argument
2025-11-18T07:44:58.052890Z 10  Query    SHOW VARIABLES LIKE '%general%'
2025-11-18T07:45:15.666672Z 10  Query    SHOW VARIABLES LIKE 'general_log%'
2025-11-18T07:45:28.970765Z 10  Query    select * from student
2025-11-18T07:47:38.706804Z 11  Connect  root@localhost on using Socket
2025-11-18T07:47:38.707435Z 11  Query    select @@version_comment limit 1
2025-11-18T07:48:21.384886Z 12  Connect  root@192.168.188.150 on using TCP/IP
2025-11-18T07:48:21.385253Z 12  Query    SET NAMES utf8
2025-11-18T07:48:21.385640Z 12  Query    USE test1
2025-11-18T07:48:21.386179Z 12  Query    SHOW FULL TABLES WHERE Table_Type != 'VIEW'
2025-11-18T07:48:23.901778Z 13  Connect  root@192.168.188.150 on using TCP/IP
2025-11-18T07:48:23.902128Z 13  Query    SET NAMES utf8
2025-11-18T07:48:23.905179Z 13  Query    USE test
2025-11-18T07:48:23.905825Z 13  Query    SHOW FULL TABLES WHERE Table_Type != 'VIEW'
2025-11-18T07:48:32.163833Z 14  Connect  root@192.168.188.150 on using TCP/IP
2025-11-18T07:48:32.164451Z 14  Query    SET NAMES utf8
2025-11-18T07:48:32.164840Z 14  Query    USE test
2025-11-18T07:48:40.006687Z 14  Query    select * from account
```

在通用查询日志里面，我们可以清楚地看到，什么时候开启了新的客户端登陆数据库，登录之后做了什么 SQL 操作，针对的是哪个数据表等信息。

### 停止日志

**方式1：永久性方式**

修改 `my.cnf` 或者 `my.ini` 文件，把`[mysqld]`组下的 `general_log` 值设置为 `OFF` 或者把`general_log`一项注释掉。修改保存后，再**重启 MySQL 服务**，即可生效。

```ini
[mysqld]
general_log=OFF

# 或

[mysqld]
#general_log=ON
```

**方式2：临时性方式**

使用`SET`语句停止 MySQL 通用查询日志功能：

```sql
SET GLOBAL general_log=off;
```

### 删除/刷新日志

如果数据的使用非常频繁，那么通用查询日志会占用服务器非常大的磁盘空间。数据管理员可以删除很长时间之前的查询日志，以保证 MySQL 服务器上的硬盘空间。

**手动删除文件**

查看通用查询日志的位置：

```sql
SHOW VARIABLES LIKE 'general_log%';
```

可以看出，通用查询日志的目录默认为 MySQL 数据目录。在该目录下手动删除通用查询日志`test.log`。

---

**刷新日志文件/重新生成日志文件**

使用如下命令重新生成查询日志文件，具体命令如下。刷新 MySQL 数据目录，发现创建了新的日志文件。前提一定要开启通用日志。

```shell
mysqladmin -uroot -p flush-logs
```

::: warning

通用查询日志都是使用`mysqladmin flush-logs`命令来删除重建的。

使用时，如果旧的还需要通用查询日志，请手动保存，因为该命令会覆盖掉旧的通用查询日志。

正确流程如下：

```shell
cd mysql-data-directory  #输入自己的通用日志文件所在目录
mv mysql.general.log mysql.general.log.old  #指名旧的文件名 以及 新的文件名
mysqladmin -uroot -p flush-logs
```

:::



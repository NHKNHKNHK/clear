# 什么是索引下推？:star:

> MySQL5.6引入，默认开启，使用`SET optimizer_switch='index_condition_pushdown=off'`可以关闭索引下推优化。`


索引下推（Index Pushdown）是一种优化查询性能的技术，主要用于数据库系统中，以减少不必要的数据访问和提升查询效率。

## 索引下推的概念

在传统的索引扫描过程中，数据库通常会先通过索引定位到符合条件的记录位置，然后再回表（访问实际数据行）进行进一步的过滤。这可能导致读取大量不必要的数据。

索引下推通过在索引扫描阶段提前应用部分查询条件，从而**减少回表次数和读取的数据量**。具体来说：

- **提前过滤**：在索引扫描时，尽可能多地应用查询条件，以减少需要回表的记录数量。

- **减少I/O操作**：通过减少回表次数，降低磁盘I/O负担，提高查询速度。

## 应用场景

索引下推在以下情况下特别有效：

- **复合索引**：对于包含多个列的复合索引，索引下推可以在索引扫描阶段应用非索引前缀列的过滤条件。例如：`like %三`肯定是会导致索引失效的，但是有了索引下推，就可以将`like %三`提前过滤掉，从而减少回表次数。

- **范围查询**：在进行范围查询时，可以通过索引下推减少不必要的数据访问

## MySQL官方示例 {#icp-example}

people表中（zipcode，lastname，firstname）构成一个索引

```sql
SELECT * FROM people WHERE zipcode='95054' AND lastname LIKE '%etrunia%' AND address LIKE '%Main Street%';
```

- 如果没有使用索引下推技术，则MySQL会通过`zipcode='95054'`从存储引擎中查询对应的数据，返回到MySQL服务端，然后MySQL服务端基于`lastname LIKE '%etrunia%'`和`address LIKE '%Main Street%'`来判断数据是否符合条件（也就是**回表**操作）

---

- 如果使用了索引下推技术，则MySQL首先会返回符合`zipcode='95054'`的索引，然后根据`lastname LIKE '%etrunia%'`来判断索引是否符合条件

  - 如果符合条件，则根据该索引来定位对应的数据
  - 如果不符合，则直接reject掉。 有了索引下推优化，可以在有like条件查询的情况下，减少回表次数。

如果说数据量非常的大，那么索引下推所带来的性能提升是非常明显的。比如根据`zipcode='95054'`匹配到10万条数据，如果没有使用索引下推优化技术，那么需要回表10万次。如果有了索引下推优化，根据`zipcode='95054'`匹配到的数据可以先不回表，而是接着根据`lastname LIKE '%etrunia%'`过滤，如果过滤后只有5千条符合条件的数据，只需要5千次回表。

:::tip
需要再次强调的是，能够利用上索引下推的字段都必须存在于联合索引中。更多索引下推的使用条件可以查看：[ICP 的使用条件](./索引优化与查询优化.md#icp-condition)

当一条SQL使用到索引下推时，explain的执行计划中的extra字段中内容为：`Using index condition`
:::

## 扩展

### 索引下推不止LIKE

上面的例子中，提到了LIKE，包括MySQL官网中也只提到了LIKE，但是其实不止有LIKE。**因为我认为索引下推其实是解决索引失效带来的效率低的问题的一种手段。**

所以当联合索引中，某个非前导列因为索引失效而要进行扫表并回表时，就可以进行索引下推优化了。

------

如，有a,b联合索引，类型都是varchar，以下SQL也可以用到索引下推：

```sql
select d from t2 where a = "ni" and b = 1; 
```

因为b字段因为类型不匹配导致索引失效了，但是通过下推优化其实是可以减少回表的次数的
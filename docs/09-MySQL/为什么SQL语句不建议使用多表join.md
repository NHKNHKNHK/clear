---
permalink: /25/10/24/mysql/not-3-join
---

# 为什么SQL语句不建议使用多表join

## 口语化

为什么不要过多使用join的原因就是join的效率比较低，主要体现在两个方面：

**性能问题**

每个join操作都需要对两个或多个表进行连接操作，这个操作需要消耗大量的计算资源和时间。如果join太多，会导致SQL的执行效率下降。特别是在数据量大的时候

**可读性和维护性**

join操作会使得SQL语句变得复杂，难以维护和理解。特别是join操作涉及到多个表的时候，SQL语句的复杂度会呈现指数的增长，给代码的可读性和可维护性带来挑战。

## 分析

MySQL是使用了嵌套循环（Nested-Loop Join）的方式来实现关联查询（多表查询）的，简单点说就是要通过两层循环，用第一张表做外循环，第二张表做内循环，外循环的每一条记录跟内循环中的记录作比较，符合条件的就输出。

而具体到算法实现上主要有simple nested loop，block nested loop和index nested loop这三种。而且这三种的效率都没有特别高。

MySQL是使用了嵌套循环（Nested-Loop Join）的方式来实现关联查询的，如果有2张表join的话，复杂度最高是`O(n^2)`，3张表则是`O(n^3)`...随着表越多，表中的数据量越多，JOIN的效率会呈指数级下降

### MySQL 8.0中新增 hash join算法

hash join 是 MySQL 8.0.18版本中新推出的一种多表join的算法

其主要目的是为了优化MySQL中join效率低的问题

## 扩展

### join

在MySQL 中，可以使用 JOIN 在两个或多个表中进行联合查询，join有三种，分别是inner join、left join 和 right join。

-   INNER JOIN（内连接）：获取两个表中字段匹配关系的记录。
    -   取两个表的交集部分
-   LEFT JOIN（左外连接）：获取左表所有记录，即使右表没有对应匹配的记录。
    -   取两个表的交集部分+左表中的数据
-   RIGHT JOIN（右外连接）： 与 LEFT JOIN 相反，用于获取右表所有记录，即使左表没有对应匹配的记录。
    -   取两个表的交集部分+右表中的数据

:::tip
详细[多表查询分类](./多表查询分类.md)
:::

### 嵌套循环算法

MySQL是使用了嵌套循环（Nested-Loop Join）的方式来实现关联查询的，具体到算法上面主要有simple nested loop join，block nested loop join和index nested loop join这三种。

而这三种的效率都没有特别高。

- simple nested loop

他的做法简单粗暴，就是全量扫描连接两张表进行数据的两两对比，所以他的复杂度可以认为是 N*M

> 说明：N是驱动表的数量，M是被驱动表的数量

- index nested loop

当Inner Loop的表用到字段有索引的话，可以用到索引进行查询数据，因为索引是B+树的，复杂度可以近似认为是 N*logM

- block nested loop

其实是引入了一个Buffer，会提前把外循环的一部分结果提前放到join buffer中，然后内循环的每一行都和整个buffer的数据作比较。虽然比较次数还是 N*M，但是因为join buffer是基于内存的，所以效率高很多。


**总结**

虽然MySQL已经尽可能的在优化了，但是这几种算法复杂度都还是挺高的，这也是为什么不建议在数据库中多表JOIN的原因。随着表越多，表中的数据量越多，JOIN的效率会呈指数级下降


## 不能用join如何做关联查询

如果不能通过数据库做关联查询，那么需要查询多表的数据的时候要怎么做呢？

主要有两种做法：

- 1、在内存中自己做关联，即先从数据库中把数据查出来之后，我们在代码中再进行二次查询，然后再进行关联（即代码中组装数据）
- 2、数据冗余，那就是把一些重要的数据在表中做冗余，这样就可以避免关联查询了

其他做法

- 宽表，就是基于一定的join关系，把数据库中多张表的数据打平做一张大宽表，可以同步到ES或者干脆直接在数据库中直接查都可以


## 阿里规约

【强制】超过三个表禁止 join。需要 join 的字段，数据类型保持绝对一致；多表关联查询时，保证被关联的字段需要有索引。

> 说明：即使双表 join 也要注意表索引、SQL 性能

解释：

- 超过三个表禁止 join，是因为在MySQL底层是使用嵌套循环来实现关联查询的，三个表相对于时间复杂度是O(n^3)，因此禁止
- 保证被关联的字段需要有索引，是因为嵌套循环算法 index nested loop 相比于 simple nested loop 效率更高
